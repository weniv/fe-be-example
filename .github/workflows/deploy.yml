# GitHub Actions ë°°í¬ ì›Œí¬í”Œë¡œìš°
# FastAPI í• ì¼ ê´€ë¦¬ ì•±ì„ AWS EC2ì— ìë™ ë°°í¬

name: Deploy - EC2 ìë™ ë°°í¬

# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´
# main ë˜ëŠ” master ë¸Œëœì¹˜ì— pushí•  ë•Œë§Œ ë°°í¬ ì‹¤í–‰
on:
  push:
    branches: [ main, master ]

jobs:
  # ë°°í¬ ì‘ì—… ì •ì˜
  deploy:
    name: ğŸš€ EC2 ë°°í¬
    runs-on: ubuntu-latest
    
    # CI í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí•œ ê²½ìš°ì—ë§Œ ë°°í¬ ì‹¤í–‰
    # (CI ì›Œí¬í”Œë¡œìš°ì™€ ë³‘ë ¬ ì‹¤í–‰ë˜ë¯€ë¡œ í˜„ì¬ëŠ” ì£¼ì„ ì²˜ë¦¬)
    # needs: test
    
    steps:
    # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: ğŸ“¥ ì†ŒìŠ¤ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      uses: actions/checkout@v4
    
    # 2. ë°°í¬ ì „ ì •ë³´ ì¶œë ¥
    - name: ğŸ“‹ ë°°í¬ ì •ë³´ í™•ì¸
      run: |
        echo "ğŸš€ FastAPI í• ì¼ ê´€ë¦¬ ì•± ë°°í¬ ì‹œì‘"
        echo "ğŸ“… ë°°í¬ ì‹œê°„: $(date)"
        echo "ğŸŒ¿ ë¸Œëœì¹˜: ${{ github.ref_name }}"
        echo "ğŸ‘¤ ë°°í¬ì: ${{ github.actor }}"
        echo "ğŸ“¦ ì»¤ë°‹: ${{ github.sha }}"
        echo ""
        echo "ğŸ“ í”„ë¡œì íŠ¸ êµ¬ì¡°:"
        ls -la
        echo ""
        echo "ğŸ“¦ ë°±ì—”ë“œ ì˜ì¡´ì„±:"
        cat backend/requirements.txt
    
    # 3. SSHë¥¼ í†µí•œ EC2 ì„œë²„ ë°°í¬
    # ì‹¤ì œ ë°°í¬ë¥¼ ìœ„í•´ì„œëŠ” ë‹¤ìŒ GitHub Secrets ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤:
    # - EC2_SSH_KEY: EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ SSH ê°œì¸ í‚¤ (.pem íŒŒì¼ ë‚´ìš©)
    # - EC2_HOST: EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ í¼ë¸”ë¦­ IP ì£¼ì†Œ
    # - EC2_USER: EC2 ì¸ìŠ¤í„´ìŠ¤ ì‚¬ìš©ìëª… (ë³´í†µ ubuntu)
    # - SECRET_KEY: FastAPI ì•±ì˜ JWT ì‹œí¬ë¦¿ í‚¤
    # - DATABASE_URL: í”„ë¡œë•ì…˜ ë°ì´í„°ë² ì´ìŠ¤ URL (ì„ íƒì‚¬í•­)
    
    - name: ğŸ”‘ EC2 ë°°í¬ (ë°ëª¨ ë²„ì „)
      run: |
        echo "ğŸ”§ ì‹¤ì œ ë°°í¬ë¥¼ ìœ„í•œ ì„¤ì • ê°€ì´ë“œ:"
        echo ""
        echo "1ï¸âƒ£ GitHub Secrets ì„¤ì • (Settings > Secrets and variables > Actions):"
        echo "   - EC2_SSH_KEY: SSH ê°œì¸ í‚¤ íŒŒì¼ ë‚´ìš©"
        echo "   - EC2_HOST: EC2 í¼ë¸”ë¦­ IP ì£¼ì†Œ" 
        echo "   - EC2_USER: EC2 ì‚¬ìš©ìëª… (ì˜ˆ: ubuntu)"
        echo "   - SECRET_KEY: JWT ì‹œí¬ë¦¿ í‚¤"
        echo "   - DATABASE_URL: PostgreSQL URL (ì„ íƒì‚¬í•­)"
        echo ""
        echo "2ï¸âƒ£ EC2 ì¸ìŠ¤í„´ìŠ¤ ì¤€ë¹„:"
        echo "   - Ubuntu 22.04 LTS"
        echo "   - Python 3.11, Nginx ì„¤ì¹˜"
        echo "   - ë³´ì•ˆ ê·¸ë£¹: SSH(22), HTTP(80), HTTPS(443) í¬íŠ¸ ì—´ê¸°"
        echo ""
        echo "3ï¸âƒ£ ì‹¤ì œ ë°°í¬ ëª…ë ¹ì–´ (í˜„ì¬ëŠ” ì£¼ì„ ì²˜ë¦¬ë¨):"
        echo "   ì•„ë˜ ì£¼ì„ì„ í•´ì œí•˜ê³  GitHub Secretsë¥¼ ì„¤ì •í•˜ë©´ ìë™ ë°°í¬ë©ë‹ˆë‹¤."
    
    # ì‹¤ì œ EC2 ë°°í¬ ì½”ë“œ (GitHub Secrets ì„¤ì • í›„ ì£¼ì„ í•´ì œ)
    - name: ğŸš€ EC2ì— ì‹¤ì œ ë°°í¬ (ì‹¤í–‰í•˜ë ¤ë©´ ì£¼ì„ í•´ì œ)
      if: false  # ì‹¤ì œ ë°°í¬ ì‹œ ì´ ì¤„ì„ ì œê±°í•˜ê±°ë‚˜ trueë¡œ ë³€ê²½
      run: |
        # SSH í‚¤ ì„¤ì •
        echo "${{ secrets.EC2_SSH_KEY }}" > deploy_key.pem
        chmod 600 deploy_key.pem
        
        # EC2 ì„œë²„ì— ë°°í¬ ëª…ë ¹ ì‹¤í–‰
        ssh -i deploy_key.pem -o StrictHostKeyChecking=no \
          ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          
          # ì„œë²„ì—ì„œ ì‹¤í–‰ë  ë°°í¬ ìŠ¤í¬ë¦½íŠ¸
          echo "ğŸ”„ ì„œë²„ì—ì„œ ë°°í¬ ì‘ì—… ì‹œì‘..."
          
          # 1. í”„ë¡œì íŠ¸ ì—…ë°ì´íŠ¸
          cd ~/fastapi-app || exit 1
          git pull origin main
          
          # 2. Python ê°€ìƒí™˜ê²½ í™œì„±í™”
          source venv/bin/activate
          
          # 3. ì˜ì¡´ì„± ì—…ë°ì´íŠ¸
          cd backend
          pip install -r requirements.txt
          
          # 4. í™˜ê²½ë³€ìˆ˜ ì„¤ì • (ì˜µì…˜)
          # echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" > .env
          # echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env
          
          # 5. ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘
          # systemctl --user restart fastapi-app
          # ë˜ëŠ” PM2 ì‚¬ìš© ì‹œ: pm2 restart fastapi-app
          
          # 6. Nginx ì„¤ì • ë¦¬ë¡œë“œ (í•„ìš”í•œ ê²½ìš°)
          # sudo nginx -t && sudo systemctl reload nginx
          
          echo "âœ… ì„œë²„ ë°°í¬ ì™„ë£Œ!"
          
        EOF
        
        # ì„ì‹œ í‚¤ íŒŒì¼ ì‚­ì œ
        rm -f deploy_key.pem
    
    # 4. ë°°í¬ ì™„ë£Œ ì•Œë¦¼
    - name: ğŸ‰ ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      if: success()
      run: |
        echo "ğŸ‰ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo ""
        echo "ğŸŒ ì„œë¹„ìŠ¤ í™•ì¸:"
        echo "   - API ì„œë²„: http://your-ec2-ip:8000"
        echo "   - API ë¬¸ì„œ: http://your-ec2-ip:8000/docs" 
        echo "   - í—¬ìŠ¤ì²´í¬: http://your-ec2-ip:8000/health"
        echo ""
        echo "ğŸ“Š ë°°í¬ í†µê³„:"
        echo "   - ë°°í¬ ì‹œê°„: $(date)"
        echo "   - ì»¤ë°‹: ${{ github.sha }}"
        echo "   - ë°°í¬ì: ${{ github.actor }}"
    
    # 5. ë°°í¬ ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
    - name: âŒ ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
      if: failure()
      run: |
        echo "âŒ ë°°í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!"
        echo ""
        echo "ğŸ” í™•ì¸ ì‚¬í•­:"
        echo "   1. GitHub Secretsê°€ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸"
        echo "   2. EC2 ì¸ìŠ¤í„´ìŠ¤ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸"
        echo "   3. SSH í‚¤ê°€ ìœ íš¨í•œì§€ í™•ì¸"
        echo "   4. ë³´ì•ˆ ê·¸ë£¹ ì„¤ì • í™•ì¸"
        echo ""
        echo "ğŸ“ ë¬¸ì œ í•´ê²°ì´ í•„ìš”í•˜ë©´ ê°œë°œíŒ€ì— ë¬¸ì˜í•˜ì„¸ìš”."