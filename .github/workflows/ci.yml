# GitHub Actions CI/CD ì›Œí¬í”Œë¡œìš°
# FastAPI í• ì¼ ê´€ë¦¬ ì•±ì˜ ìë™í™”ëœ í…ŒìŠ¤íŠ¸ ë° ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬

name: CI - í…ŒìŠ¤íŠ¸ ë° ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬

# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´
# - main, master ë¸Œëœì¹˜ì— pushí•  ë•Œ
# - Pull Requestê°€ ìƒì„±ë˜ê±°ë‚˜ ì—…ë°ì´íŠ¸ë  ë•Œ  
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # í…ŒìŠ¤íŠ¸ ì‘ì—… ì •ì˜
  test:
    name: ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    runs-on: ubuntu-latest  # GitHubì—ì„œ ì œê³µí•˜ëŠ” Ubuntu í™˜ê²½
    
    steps:
    # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: ğŸ“¥ ì†ŒìŠ¤ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      uses: actions/checkout@v4
    
    # 2. Python 3.11 í™˜ê²½ ì„¤ì •
    - name: ğŸ Python 3.11 ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    # 3. pip ìºì‹œ ì„¤ì • (ë¹Œë“œ ì†ë„ í–¥ìƒ)
    - name: ğŸ“¦ pip ìºì‹œ ì„¤ì •
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    # 4. Python ì˜ì¡´ì„± ì„¤ì¹˜
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # 5. FastAPI ì•± ë¡œë“œ í…ŒìŠ¤íŠ¸
    - name: ğŸš€ FastAPI ì•± ë¡œë“œ í…ŒìŠ¤íŠ¸
      run: |
        cd backend
        # Python ê²½ë¡œì— í˜„ì¬ ë””ë ‰í† ë¦¬ ì¶”ê°€
        export PYTHONPATH=$PYTHONPATH:$(pwd)
        # FastAPI ì•±ì´ ì •ìƒì ìœ¼ë¡œ ë¡œë“œë˜ëŠ”ì§€ í™•ì¸
        python -c "
        try:
            from app.main import app
            print('âœ… FastAPI ì•±ì´ ì„±ê³µì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!')
            print(f'ğŸ“Š ì•± ì œëª©: {app.title}')
            print(f'ğŸ“ ì•± ì„¤ëª…: {app.description}')
            print(f'ğŸ”¢ ì•± ë²„ì „: {app.version}')
        except Exception as e:
            print(f'âŒ FastAPI ì•± ë¡œë“œ ì‹¤íŒ¨: {e}')
            exit(1)
        "
    
    # 6. ë°ì´í„°ë² ì´ìŠ¤ ëª¨ë¸ í…ŒìŠ¤íŠ¸
    - name: ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ëª¨ë¸ í…ŒìŠ¤íŠ¸
      run: |
        cd backend
        export PYTHONPATH=$PYTHONPATH:$(pwd)
        python -c "
        try:
            from app.database import engine, Base
            from app.models import Todo
            
            # ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸” ìƒì„± í…ŒìŠ¤íŠ¸
            Base.metadata.create_all(bind=engine)
            print('âœ… ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!')
            
            # Todo ëª¨ë¸ ì†ì„± í™•ì¸
            print('ğŸ“‹ Todo ëª¨ë¸ ì •ë³´:')
            print(f'  - í…Œì´ë¸”ëª…: {Todo.__tablename__}')
            print(f'  - ì»¬ëŸ¼: {list(Todo.__table__.columns.keys())}')
            
        except Exception as e:
            print(f'âŒ ë°ì´í„°ë² ì´ìŠ¤ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {e}')
            exit(1)
        "
      
    # 7. CRUD ì‘ì—… í…ŒìŠ¤íŠ¸
    - name: ğŸ“Š CRUD ì‘ì—… í…ŒìŠ¤íŠ¸
      run: |
        cd backend
        export PYTHONPATH=$PYTHONPATH:$(pwd)
        python -c "
        try:
            from app.crud import TodoCreate, TodoUpdate, TodoResponse
            from pydantic import ValidationError
            
            # Pydantic ìŠ¤í‚¤ë§ˆ í…ŒìŠ¤íŠ¸
            print('ğŸ” Pydantic ìŠ¤í‚¤ë§ˆ í…ŒìŠ¤íŠ¸:')
            
            # ìœ íš¨í•œ TodoCreate ìŠ¤í‚¤ë§ˆ í…ŒìŠ¤íŠ¸
            valid_todo = TodoCreate(title='í…ŒìŠ¤íŠ¸ í• ì¼', description='í…ŒìŠ¤íŠ¸ ì„¤ëª…')
            print(f'  âœ… ìœ íš¨í•œ í• ì¼: {valid_todo.title}')
            
            # í•„ìˆ˜ í•„ë“œ ëˆ„ë½ í…ŒìŠ¤íŠ¸
            try:
                invalid_todo = TodoCreate(description='ì œëª© ì—†ëŠ” í• ì¼')
                print('  âŒ ê²€ì¦ ì‹¤íŒ¨: ì œëª© ì—†ì´ í• ì¼ì´ ìƒì„±ë¨')
                exit(1)
            except ValidationError:
                print('  âœ… ì œëª© í•„ìˆ˜ ê²€ì¦ ì„±ê³µ')
            
            print('âœ… ëª¨ë“  CRUD ìŠ¤í‚¤ë§ˆ í…ŒìŠ¤íŠ¸ í†µê³¼!')
            
        except Exception as e:
            print(f'âŒ CRUD í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: {e}')
            exit(1)
        "
    
    # 8. ì½”ë“œ í’ˆì§ˆ ì²´í¬ (ì„ íƒì‚¬í•­)
    - name: ğŸ” ì½”ë“œ í’ˆì§ˆ ì²´í¬
      run: |
        cd backend
        # Python ì½”ë“œ êµ¬ë¬¸ ê²€ì‚¬
        python -m py_compile app/main.py app/models.py app/database.py app/crud.py
        echo "âœ… ëª¨ë“  Python íŒŒì¼ì˜ êµ¬ë¬¸ì´ ì˜¬ë°”ë¦…ë‹ˆë‹¤!"
    
    # 9. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
    - name: ğŸ“‹ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
      if: always()  # ì´ì „ ë‹¨ê³„ê°€ ì‹¤íŒ¨í•´ë„ ì‹¤í–‰
      run: |
        echo "ğŸ¯ CI í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"
        echo "âœ… FastAPI ì•± ë¡œë“œ: ì„±ê³µ"
        echo "âœ… ë°ì´í„°ë² ì´ìŠ¤ ëª¨ë¸: ì„±ê³µ"
        echo "âœ… CRUD ìŠ¤í‚¤ë§ˆ: ì„±ê³µ"
        echo "âœ… ì½”ë“œ í’ˆì§ˆ: ì„±ê³µ"
        echo ""
        echo "ğŸš€ ë°°í¬ ì¤€ë¹„ ì™„ë£Œ! ì´ì œ ì•ˆì „í•˜ê²Œ ë°°í¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."